{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>New Sale</h1>
    
    <!-- Customer Search -->
    <div class="mb-4">
        <label for="customerSearch">Search Customer:</label>
        <input type="text" id="customerSearch" class="form-control" placeholder="Type customer name...">
        <div id="customerResults" class="list-group mt-2"></div>
    </div>

    <!-- Selected Customer Info -->
    <div id="selectedCustomer" class="mb-4" style="display: none;">
        <h3>Selected Customer</h3>
        <div id="customerInfo"></div>
    </div>

    <!-- Product Selection -->
    <div class="mb-4">
        <h3>Add Products</h3>
        <div class="input-group mb-3">
            <input type="text" id="productSearch" class="form-control" placeholder="Search products...">
            <button class="btn btn-outline-secondary" type="button" id="addProduct">Add Product</button>
        </div>
        <div id="productResults" class="list-group mt-2"></div>
    </div>

    <!-- Products Table -->
    <table class="table" id="selectedProducts">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Cost Price</th>
                <th>Selling Price</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
        <tfoot>
            <tr>
                <td colspan="4"><strong>Total Amount:</strong></td>
                <td id="totalAmount">0.00</td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <!-- Payment Information -->
    <div class="mb-4">
        <label for="amountReceived">Amount Received:</label>
        <input type="number" id="amountReceived" class="form-control" step="0.01">
        <div id="balanceInfo" class="mt-2"></div>
    </div>

    <button id="completeSale" class="btn btn-primary">Complete Sale</button>
</div>

<script>
let selectedCustomerId = null;
let selectedProducts = [];

// Customer search
document.getElementById('customerSearch').addEventListener('input', async (e) => {
    const query = e.target.value;
    if (query.length < 2) return;
    
    const response = await fetch(`/api/search/customers?query=${encodeURIComponent(query)}`);
    const customers = await response.json();
    
    const resultsDiv = document.getElementById('customerResults');
    resultsDiv.innerHTML = customers.map(customer => `
        <a href="#" class="list-group-item" data-id="${customer.id}">
            ${customer.name} (${customer.email})
        </a>
    `).join('');
    
    resultsDiv.querySelectorAll('a').forEach(a => {
        a.addEventListener('click', (e) => {
            e.preventDefault();
            selectedCustomerId = e.target.dataset.id;
            document.getElementById('customerInfo').innerHTML = `
                <p>Name: ${e.target.textContent}</p>
            `;
            document.getElementById('selectedCustomer').style.display = 'block';
            document.getElementById('customerResults').innerHTML = '';
            document.getElementById('customerSearch').value = '';
        });
    });
});

// Product search and add
document.getElementById('productSearch').addEventListener('input', async (e) => {
    const query = e.target.value;
    if (query.length < 2) return;
    
    const response = await fetch(`/api/search/products?query=${encodeURIComponent(query)}`);
    const products = await response.json();
    
    const resultsDiv = document.getElementById('productResults');
    resultsDiv.innerHTML = products.map(product => `
        <a href="#" class="list-group-item" data-id="${product.id}" data-name="${product.name}" 
           data-price="${product.price}">
            ${product.name} (Cost Price: ${product.price})
        </a>
    `).join('');
    
    resultsDiv.querySelectorAll('a').forEach(a => {
        a.addEventListener('click', (e) => {
            e.preventDefault();
            const selectedProduct = {
                id: e.target.dataset.id,
                name: e.target.dataset.name,
                costPrice: parseFloat(e.target.dataset.price),
                quantity: 1,
                sellingPrice: 0 // Placeholder for user input
            };
            addProductToTable(selectedProduct);
            document.getElementById('productResults').innerHTML = '';
            document.getElementById('productSearch').value = '';
        });
    });
});

// Add product to table
function addProductToTable(product) {
    const tbody = document.querySelector('#selectedProducts tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${product.name}</td>
        <td><input type="number" value="1" min="1" class="form-control quantity-input"></td>
        <td>${product.costPrice.toFixed(2)}</td>
        <td><input type="number" step="0.01" class="form-control selling-price-input" placeholder="Enter selling price"></td>
        <td class="total">0.00</td>
        <td><button class="btn btn-danger btn-sm remove-product">Remove</button></td>
    `;
    tbody.appendChild(tr);
    selectedProducts.push(product);
    updateTotalAmount();

    // Add event listeners
    tr.querySelector('.quantity-input').addEventListener('change', () => updateProductTotal(tr, product));
    tr.querySelector('.selling-price-input').addEventListener('change', () => updateProductTotal(tr, product));
    tr.querySelector('.remove-product').addEventListener('click', () => removeProduct(tr, product));
}

function updateProductTotal(tr, product) {
    const quantity = parseInt(tr.querySelector('.quantity-input').value);
    const sellingPrice = parseFloat(tr.querySelector('.selling-price-input').value || 0);
    product.quantity = quantity;
    product.sellingPrice = sellingPrice;

    const total = quantity * sellingPrice;
    tr.querySelector('.total').textContent = total.toFixed(2);
    updateTotalAmount();
}

function removeProduct(tr, product) {
    const index = selectedProducts.indexOf(product);
    selectedProducts.splice(index, 1);
    tr.remove();
    updateTotalAmount();
}

function updateTotalAmount() {
    const total = selectedProducts.reduce((sum, product) => sum + (product.quantity * product.sellingPrice), 0);
    document.getElementById('totalAmount').textContent = total.toFixed(2);
}

// Complete sale
document.getElementById('completeSale').addEventListener('click', async () => {
    if (!selectedCustomerId || selectedProducts.length === 0) {
        alert('Please select a customer and add products');
        return;
    }
    
    const saleData = {
        customer_id: selectedCustomerId,
        items: selectedProducts.map(p => ({
            product_id: p.id,
            quantity: p.quantity,
            selling_price: p.sellingPrice
        })),
        amount_received: parseFloat(document.getElementById('amountReceived').value || 0)
    };
    
    try {
        const response = await fetch('/sales/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(saleData)
        });
        
        if (response.ok) {
            const sale = await response.json();
            window.location.href = `/invoices/${sale.id}`;
        } else {
            const error = await response.json();
            alert(error.detail);
        }
    } catch (error) {
        alert('Error creating sale');
    }
});
</script>
{% endblock %}
